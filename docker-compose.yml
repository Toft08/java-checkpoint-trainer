version: "3.8"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: checkpoint-trainer-backend
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - APP_CORS_ALLOWED_ORIGINS=http://localhost:4200,http://localhost
      - APP_CHECKPOINT_BASE_PATH=/exercises
      - APP_CHECKPOINT_DOCKER_IMAGE=ghcr.io/01-edu/test-java
      - APP_CHECKPOINT_DOCKER_TIMEOUT=60
    volumes:
      # Mount exercise folders as read-only
      - ./g1:/exercises/g1:ro
      - ./g2:/exercises/g2:ro
      - ./g3:/exercises/g3:ro
      - ./g4:/exercises/g4:ro
      # Mount Docker socket to allow backend to run containers
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - checkpoint-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8080/api/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: checkpoint-trainer-frontend
    ports:
      - "80:80"
      - "4200:80" # Also expose on 4200 for consistency with dev mode
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - checkpoint-network
    environment:
      - BACKEND_URL=http://backend:8080/api

networks:
  checkpoint-network:
    driver: bridge
